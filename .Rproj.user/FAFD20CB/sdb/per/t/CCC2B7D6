{
    "collab_server" : "",
    "contents" : "#####################################################################################\n################## Code for analysing data on vegetation plots 2015 #################\n#####################################################################################\n\n#Reading data \ndata_veg<-read.table(\"./data/clean/datafile_vegplots.txt\",header=T,sep=\"\\t\",dec=\",\")\nhead(data_veg)\ntail(data_veg)\nstr(data_veg)\n\nattach(data_veg)\ndata_veg$plot<-as.factor(data_veg$plot)\n\n# #Construct new variable\n# #Is plant higher than vegetation?\n# data_veg$higher_veg_max<-as.factor(with(data_veg,ifelse(diff_veg_h_max_shoot_h<0,\"1\",\"0\")))\n# data_veg$higher_veg_mean<-as.factor(with(data_veg,ifelse(diff_veg_h_mean_shoot_h<0,\"1\",\"0\")))\n# \n#Construct new variable: attack\ndata_veg$attack<-as.factor(with(data_veg,ifelse(n_eggs_max>0,\"1\",\"0\")))\n# \n# #Construct new variable: redants_pres\n# data_veg$redants_pres<-as.factor(with(data_veg,ifelse(n_redants>0,\"1\",\"0\")))\n# \n# #Construct new variable: prop_pred\n# data_veg$prop_pred<-with(data_veg,n_predated/n_fl_corrected)\n# \n#Construct new variable: observation-level random effect\ndata_veg$id<-1:100\n\n# summary(data_veg)\n# names(data_veg)\n# \n# plot(attack,most_adv)\n# summary(lm(fruit_set~attack))\n# plot(attack,n_fruits_total)\n\n#Correlations\nlibrary(PerformanceAnalytics)\ndata_vegcorr<-data_veg[c(4:10,17:34)]\ncor(data_vegcorr,use=\"pairwise.complete.obs\" )\nwrite.table(cor(data_vegcorr,use=\"pairwise.complete.obs\" ),\"clipboard\",sep=\"\\t\")\nchart.Correlation(data_vegcorr,pch=20)\n\n#PCA\nPCA1<-prcomp(~n_fl_corrected+most_adv+shoot_h,center=T,scale=T)\nplot(PCA1)\nbiplot(PCA1)\nPCA1\nsummary(PCA1)\n\n###########################################################################\n\n#Boxplots\nfor (i in 4:ncol(data_veg)){boxplot(as.numeric(data_veg[,i]),main=paste(colnames(data_veg)[i]))}\n\n#Histograms\nfor (i in 4:ncol(data_veg)){hist(as.numeric(data_veg[,i]),main=paste(colnames(data_veg)[i]))}\n\n############################################################################\n\n#Standardize X variables\nz <- scale(data_veg[,c(\"bud_h\",\"shoot_h\",\"veg_h_mean\",\"diff_veg_h_max_shoot_h\",\"diff_veg_h_mean_shoot_h\",\n                    \"phen_index\",\"most_adv\",\"n_intact_fruits\",\"n_predated\",\"fruit_set\",\n                    \"n_fl_corrected\",\"n_eggs_max\",\"n_redants\",\"dist_closest_redants\")])\ndata_veg$z.bud_h <- z[,1]\ndata_veg$z.shoot_h <- z[,2]\ndata_veg$z.veg_h_mean <- z[,3]\ndata_veg$z.diff_veg_h_max_shoot_h <- z[,4]\ndata_veg$z.diff_veg_h_mean_shoot_h <- z[,5]\ndata_veg$z.phen_index <- z[,6]\ndata_veg$z.most_adv <- z[,7]\ndata_veg$z.n_intact_fruits <- z[,8]\ndata_veg$z.n_predated <- z[,9]\ndata_veg$z.fruit_set <- z[,10]\ndata_veg$z.n_fl_corrected <- z[,11]\ndata_veg$z.n_eggs_max <- z[,12]\ndata_veg$z.n_redants <- z[,13]\ndata_veg$z.dist_closest_redants <- z[,14]\n\nhead(data_veg)\nsummary(data_veg)\n\n###############################################################################\n#Differences in variables between treatments?\n\nsummary(lm(phen_index~treat))\nsummary(lm(most_adv~treat))\nsummary(lm(shoot_h~treat))\nsummary(lm(n_intact_fruits~treat))\nsummary(lm(fr_int_h_max~treat))\nsummary(lm(n_predated~treat))\nsummary(lm(n_redants~treat))\nplot(treat,n_redants)  #Do ants prefere to forage where there is higher vegetation?\nsummary(lm(n_eggs_max~treat))\nsummary(lm(n_fl_corrected~treat))\nsummary(lm(fruit_set~treat))\n\n###############################################################################\n#Construct models for interaction (intensity)\n#data_veg_comp<-data_veg[complete.cases(data_veg[37:50]),]\n\n#attach(data_veg_comp)\nlibrary(lme4)\nlibrary(MuMIn)\nlibrary(car)\nmodel1v<-glm(attack~(z.shoot_h+z.most_adv+z.n_fl_corrected+z.n_redants)\n             *treat,family=\"binomial\",na.action=\"na.fail\")\nmodel1v<-glm(attack~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n             *treat,family=\"binomial\",na.action=\"na.fail\")\nsummary(model1v)\nr.squaredLR(model1v) \nvif(model1v) #High vif for ants\n\n#Model selection\nmodels1v<-dredge(model1v)\nsubset(models1v, delta <2) \nimportance(models1v) \n\nmodel1vavg<-model.avg(models1v, subset=delta <2,revised.var = TRUE)\nsummary(model1vavg)\n\n#Separate\nmodel1CUT<-glm(attack~z.shoot_h+z.most_adv+z.n_fl_corrected+z.n_redants,\n               family=\"binomial\",na.action=\"na.fail\",data=subset(data_veg,treat==\"Cut\"))\nsummary(model1CUT)\n\nmodel1UNCUT<-glm(attack~z.shoot_h+z.most_adv+z.n_fl_corrected+z.n_redants,\n                 family=\"binomial\",na.action=\"na.fail\",data=subset(data_veg,treat==\"Uncut\"))\nsummary(model1UNCUT)\n\n#Response=n_eggs_max\n\nmodel2v<-glm(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected+z.n_redants)\n             *treat,family=\"poisson\",na.action=\"na.fail\")\nsummary(model2v)\nvif(model2v) #High vif for ants\nmodel2v<-glm(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n             *treat,family=\"poisson\",na.action=\"na.fail\")\nmodel2v<-glm(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n             *treat,family=\"quasipoisson\",na.action=\"na.fail\")\nsummary(model2v)\nvif(model2v) \n1 - pchisq(summary(model2v)$deviance, \n           summary(model2v)$df.residual\n) #Model does not fit the data! Both with poisson and quasipoisson\n\nwith(subset(data_veg,treat==\"Cut\"),plot(most_adv,n_eggs_max))\nwith(subset(data_veg,treat==\"Cut\"),abline(lm(n_eggs_max~most_adv)))\nwith(subset(data_veg,treat==\"Uncut\"),plot(most_adv,n_eggs_max))\nwith(subset(data_veg,treat==\"Uncut\"),abline(lm(n_eggs_max~most_adv)))\n\n\nmodel2vnb<-glm.nb(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n             *treat,na.action=\"na.fail\")\nsummary(model2vnb)\nvif(model2vnb)\n1 - pchisq(summary(model2vnb)$deviance, \n           summary(model2vnb)$df.residual\n) #Model fits the data! But no significant effects :(\n\n#Include plot nested in treatment\n#Poisson model\nmodel2v_n<-glmer(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n           *treat+(1|plot),na.action=\"na.fail\",data=data_veg,family=\"poisson\")\n#model2v_n<-glmer(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n#*treat+(1|treat:plot),na.action=\"na.fail\",data=data_veg,family=\"poisson\")\n#Gives exactly the same output: Function is smart enought to see that since \n#plot 1 is only found in conjunction with treatment Cut, plot is nested in treatment\nsummary(model2v_n)\nr.squaredGLMM(model2v_n) \noverdisp.glmer(model2v_n) #Overdispersion\nlibrary(blmeco) \ndispersion_glmer(model2v_n) #it shouldn't be over 1.4\noverdisp_fun(model2v_n)\nlibrary(aods3)\ngof(model2v_n)\n(sum(residuals(model2v_n,\"pearson\")^2))/df.residual(model2v_n) #Overdisp. param.\n\n#Lognormal with observation-level random effect\nmodel2v_n<-glmer(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n                 *treat+(1|plot)+(1|id),na.action=\"na.fail\",data=data_veg,family=\"poisson\")\nsummary(model2v_n) #NS\nr.squaredGLMM(model2v_n) \noverdisp.glmer(model2v_n) #No overdispersion\n\n#Negative binomial\nmodel2vnb_n<-glmer.nb(n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n                      *treat+(1|plot),na.action=\"na.fail\",data=data_veg)\nsummary(model2vnb_n) #NS\n#Same smartness here\n\n#Quasipoisson\nmodel2v_n<-glmmPQL(fixed=n_eggs_max~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n                   *treat,random=~1|plot,na.action=\"na.fail\",data=data_veg,\n                   family=\"quasipoisson\")\n#And here\nsummary(model2v_n) #Only most_adv is significant\n\n#Model selection in negative binomial\nmodels2vnb_n<-dredge(model2vnb_n)\nsubset(models2vnb_n, delta <2) \nimportance(models2vnb_n) \n\nmodel2vnb_n_avg<-model.avg(models2vnb_n, subset=delta <2,revised.var = TRUE)\nsummary(model2vnb_n_avg)\n\n#With attack\nmodel2v_n<-glmer(attack~(z.shoot_h+z.most_adv+z.n_fl_corrected)\n                 *n_redants+(1|plot),na.action=\"na.fail\",data=data_veg,family=\"binomial\",\n                 control=glmerControl(optimizer=\"bobyqa\"))\n\n\n###################################################################################33\n\nxyplot(n_eggs_max~z.most_adv | treat, \n       panel=function(x, y){ \n         panel.xyplot(x, y) \n         panel.lmline(x, y, lty = 2)  # Least squares broken line\n       } \n)\n\nxyplot(n_eggs_max~z.most_adv | n_redants, \n       panel=function(x, y){ \n         panel.xyplot(x, y) \n         panel.lmline(x, y, lty = 2)  # Least squares broken line\n       } \n)\n\nxyplot(n_eggs_max~z.shoot_h | treat, \n       panel=function(x, y){ \n         panel.xyplot(x, y) \n         panel.lmline(x, y, lty = 2)  # Least squares broken line\n       } \n)\n\nxyplot(n_eggs_max~z.n_redants | treat, \n       panel=function(x, y){ \n         panel.xyplot(x, y) \n         panel.lmline(x, y, lty = 2)  # Least squares broken line\n       } \n)\n\n##########################################################################\n#Try piecewiseSEM\nlibrary(piecewiseSEM)\n\nmodList<-list(\n  glmer.nb(n_eggs_max~(most_adv+n_fl_corrected+shoot_h)*n_redants+\n             (1|plot),na.action=\"na.fail\",data=data_veg,\n           control=glmerControl(optimizer=\"bobyqa\")),\n  glmer.nb(n_redants~treat+(1|plot),na.action=\"na.fail\",data=data_veg)\n)\n\nsem.fit(modList, data_veg,\n        corr.errors = c(\"most_adv~~n_fl_corrected\",\"shoot_h~~n_fl_corrected\",\"most_adv~~shoot_h\"))\nsem.model.fits(modList)\nsem.coefs(modList, data_veg,\n          corr.errors = c(\"most_adv~~n_fl_corrected\",\"shoot_h~~n_fl_corrected\",\"most_adv~~shoot_h\"))\n\nmodel1<-glmer(n_eggs_max~n_redants+(1|id),family=\"poisson\") #Nearly * effect\n(sum(residuals(model1,\"pearson\")^2))/df.residual(model1) #Overdisp. param.\n\nmodel1<-glmer.nb(n_redants~treat+(1|plot),na.action=\"na.fail\",data=data_veg)\nmodel2<-glmer(n_redants~treat+(1|plot),na.action=\"na.fail\",data=data_veg,family=\"poisson\")\nsummary(model1) #Significant effect of treatment on ants\nsummary(model2)\nAIC(model1,model2)\n\nmodel1<-glm.nb(n_eggs_max~(most_adv+n_fl_corrected+shoot_h)*n_redants,na.action=\"na.fail\",data=data_veg)\nmodel2<-glmer.nb(n_eggs_max~(z.most_adv+z.n_fl_corrected+z.shoot_h)*z.n_redants+\n                   (1|plot),na.action=\"na.fail\",data=data_veg,\n                 control=glmerControl(optimizer=\"bobyqa\",optCtrl=list(maxfun=2e5)))\nmodel2<-glmer.nb(n_eggs_max~(most_adv+n_fl_corrected+shoot_h)*n_redants+\n                   (1|plot),na.action=\"na.fail\",data=data_veg,\n                 control=glmerControl(optimizer=\"bobyqa\"))\nmodel3<-glmer.nb(n_eggs_max~most_adv*n_redants+(1|plot),na.action=\"na.fail\",data=data_veg)\n\nsummary(model1)\nsummary(model2)\nsummary(model3)\nAIC(model1,model2,model3)\n\n(sum(residuals(model2,\"pearson\")^2))/df.residual(model2) #Overdisp. param.\n\n#Convergence problems!\n\n#Try with PCA for traits\n\nPCA1<-prcomp(~most_adv+n_fl_corrected+shoot_h,center=T,scale=T)\nplot(PCA1)\nbiplot(PCA1)\nPCA1\nsummary(PCA1)\ndata_veg$pca1<-predict(PCA1)[,1]\n\n#Models using pca1 instead of indidividual\nmodel2v_n<-glmer(n_eggs_max~pca1*n_redants+(1|plot),na.action=\"na.fail\",data=data_veg,family=\"poisson\")\nsummary(model2v_n)\n(sum(residuals(model2v_n,\"pearson\")^2))/df.residual(model2v_n) #Overdisp. param.\n\nmodel2v_n<-glmer(n_eggs_max~pca1*n_redants+(1|plot)+(1|id),na.action=\"na.fail\",data=data_veg,family=\"poisson\")\nsummary(model2v_n)\n(sum(residuals(model2v_n,\"pearson\")^2))/df.residual(model2v_n) #Overdisp. param.\n\nmodel2vnb_n<-glmer.nb(n_eggs_max~pca1*n_redants+(1|plot),na.action=\"na.fail\",data=data_veg)\nsummary(model2vnb_n)\n(sum(residuals(model2vnb_n,\"pearson\")^2))/df.residual(model2vnb_n) #Overdisp. param.\n\n",
    "created" : 1479809236640.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3742605731",
    "id" : "CCC2B7D6",
    "lastKnownWriteTime" : 1479810093,
    "last_content_update" : 1479810093627,
    "path" : "D:/SU/Projects/exp_veg_cutting/code/ex_veg_cutting_2015.R",
    "project_path" : "code/ex_veg_cutting_2015.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}